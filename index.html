<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ostatnia Reduta - Gra z Zombie</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #121212;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            color: white;
        }
        
        #game-container {
            position: relative;
            width: 800px;
            height: 600px;
        }
        
        #game-canvas {
            position: absolute;
            background-color: #222;
            border: 3px solid #444;
            border-radius: 5px;
        }
        
        #ui-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        #health-bar {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 200px;
            height: 20px;
            background-color: #333;
            border: 2px solid #555;
        }
        
        #health-fill {
            height: 100%;
            width: 100%;
            background-color: #ff3300;
        }
        
        #ammo-display {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 20px;
            color: white;
            text-shadow: 2px 2px 2px black;
        }
        
        #wave-display {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 20px;
            color: white;
            text-shadow: 2px 2px 2px black;
        }
        
        #score-display {
            position: absolute;
            top: 50px;
            right: 20px;
            font-size: 20px;
            color: white;
            text-shadow: 2px 2px 2px black;
        }
        
        #shop-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            height: 400px;
            background-color: rgba(0, 0, 0, 0.9);
            border: 3px solid #ffcc00;
            border-radius: 10px;
            padding: 20px;
            display: none;
            pointer-events: all;
            z-index: 100;
        }
        
        #shop-title {
            text-align: center;
            margin-bottom: 20px;
            color: #ffcc00;
            font-size: 24px;
        }
        
        #shop-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .shop-item {
            background-color: #333;
            border: 2px solid #555;
            border-radius: 5px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .shop-item:hover {
            border-color: #ffcc00;
            transform: scale(1.05);
        }
        
        .shop-item h3 {
            color: #ffcc00;
            margin-bottom: 5px;
        }
        
        .shop-item p {
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        #shop-controls {
            position: absolute;
            bottom: 20px;
            width: calc(100% - 40px);
            display: flex;
            justify-content: space-between;
        }
        
        #start-next-wave {
            background-color: #ff3300;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        #start-next-wave:hover {
            background-color: #ff5500;
        }
        
        #timer-display {
            position: absolute;
            top: 80px;
            left: 20px;
            font-size: 20px;
            color: white;
            text-shadow: 2px 2px 2px black;
        }
        
        #game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            border: 3px solid #ff3300;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            display: none;
            z-index: 100;
        }
        
        #game-over h2 {
            color: #ff3300;
            font-size: 36px;
            margin-bottom: 20px;
        }
        
        #final-score {
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        #restart-button {
            background-color: #ff3300;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
        }
        
        #restart-button:hover {
            background-color: #ff5500;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="game-canvas" width="800" height="600"></canvas>
        
        <div id="ui-layer">
            <div id="health-bar">
                <div id="health-fill"></div>
            </div>
            
            <div id="wave-display">Fala: 0</div>
            <div id="score-display">Punkty: 0</div>
            <div id="ammo-display">Amunicja: ∞</div>
            <div id="timer-display">Czas: 120s</div>
            
            <div id="shop-screen">
                <h2 id="shop-title">SKLEP</h2>
                <div id="shop-items">
                    <!-- Elementy sklepu będą dodane dynamicznie -->
                </div>
                <div id="shop-controls">
                    <div id="money-display">Pieniądze: 0</div>
                    <button id="start-next-wave">Rozpocznij następną falę</button>
                </div>
            </div>
            
            <div id="game-over">
                <h2>GAME OVER</h2>
                <div id="final-score">Twój wynik: 0</div>
                <button id="restart-button">Zagraj ponownie</button>
            </div>
        </div>
    </div>

    <script>
        // Podstawowe zmienne gry
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const waveDisplay = document.getElementById('wave-display');
        const scoreDisplay = document.getElementById('score-display');
        const ammoDisplay = document.getElementById('ammo-display');
        const healthBar = document.getElementById('health-fill');
        const timerDisplay = document.getElementById('timer-display');
        const shopScreen = document.getElementById('shop-screen');
        const shopItems = document.getElementById('shop-items');
        const moneyDisplay = document.getElementById('money-display');
        const startNextWaveBtn = document.getElementById('start-next-wave');
        const gameOverScreen = document.getElementById('game-over');
        const finalScoreDisplay = document.getElementById('final-score');
        const restartButton = document.getElementById('restart-button');
        
        // Zmienne stanu gry
        let gameState = 'playing'; // playing, shop, gameOver
        let score = 0;
        let money = 0;
        let currentWave = 0;
        let zombiesKilledInWave = 0;
        let zombiesToSpawn = 0;
        let shopTimer = 120; // 2 minuty na zakupy
        let shopInterval;
        
        // Gracz
        const player = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            radius: 20,
            color: 'red',
            speed: 5,
            health: 100,
            maxHealth: 100,
            weapons: [],
            currentWeaponIndex: 0
        };
        
        // Broń
        const weapons = [
            {
                name: "Pistolet",
                damage: 20,
                fireRate: 100,
                ammo: Infinity,
                cost: 0,
                color: "gray",
                size: 8
            },
            {
                name: "Shotgun",
                damage: 40,
                fireRate: 500,
                ammo: 24,
                maxAmmo: 24,
                cost: 200,
                color: "brown",
                size: 7
            },
            {
                name: "MP5",
                damage: 20,
                fireRate: 100,
                ammo: 90,
                maxAmmo: 90,
                cost: 500,
                color: "black",
                size: 6
            },
            {
                name: "Karabin",
                damage: 65,
                fireRate: 300,
                ammo: 30,
                maxAmmo: 30,
                cost: 800,
                color: "green",
                size: 8
            },
            {
                name: "Minigun",
                damage: 15,
                fireRate: 20,
                ammo: 200,
                maxAmmo: 200,
                cost: 1500,
                color: "blue",
                size: 10
            }
        ];
        
        // Początkowa broń
        player.weapons.push({...weapons[0]});
        player.currentWeapon = player.weapons[0];
        
        // Pociski
        let bullets = [];
        
        // Zombie
        let zombies = [];
        const zombieColors = ['#3a7d44', '#4a9d55', '#2d5a34'];
        
        // Ruiny (pozycje spawnu zombie)
        const ruins = [
            { x: -100, y: -100 },
            { x: canvas.width + 100, y: -100 },
            { x: -100, y: canvas.height + 100 },
            { x: canvas.width + 100, y: canvas.height + 100 },
            { x: canvas.width / 2, y: -100 },
            { x: canvas.width / 2, y: canvas.height + 100 },
            { x: -100, y: canvas.height / 2 },
            { x: canvas.width + 100, y: canvas.height / 2 }
        ];
        
        // Kontrola
        const keys = {};
        let mouse = {
            x: 0,
            y: 0,
            down: false
        };
        
        // Nasłuchiwanie zdarzeń
        window.addEventListener('keydown', e => keys[e.key] = true);
        window.addEventListener('keyup', e => keys[e.key] = false);
        
        canvas.addEventListener('mousemove', e => {
            const rect = canvas.getBoundingClientRect();
            mouse.x = e.clientX - rect.left;
            mouse.y = e.clientY - rect.top;
        });
        
        canvas.addEventListener('mousedown', () => mouse.down = true);
        canvas.addEventListener('mouseup', () => mouse.down = false);
        
        startNextWaveBtn.addEventListener('click', startNextWave);
        restartButton.addEventListener('click', restartGame);
        
        // Funkcje gry
        function gameLoop() {
            update();
            render();
            requestAnimationFrame(gameLoop);
        }
        
        function update() {
            if (gameState === 'playing') {
                updatePlayer();
                updateBullets();
                updateZombies();
                checkCollisions();
                checkWaveCompletion();
            } else if (gameState === 'shop') {
                // Sklep jest aktywny, nic nie aktualizujemy w grze
            }
        }
        
        function updatePlayer() {
            // Poruszanie się gracza
            if (keys['w'] || keys['ArrowUp']) player.y -= player.speed;
            if (keys['s'] || keys['ArrowDown']) player.y += player.speed;
            if (keys['a'] || keys['ArrowLeft']) player.x -= player.speed;
            if (keys['d'] || keys['ArrowRight']) player.x += player.speed;
            
            // Ograniczenie gracza do okręgu
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const maxDistance = 250; // Promień okręgu
            
            const dx = player.x - centerX;
            const dy = player.y - centerY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance > maxDistance - player.radius) {
                const angle = Math.atan2(dy, dx);
                player.x = centerX + Math.cos(angle) * (maxDistance - player.radius);
                player.y = centerY + Math.sin(angle) * (maxDistance - player.radius);
            }
            
            // Strzelanie
            if (mouse.down && player.currentWeapon.ammo > 0) {
                const now = Date.now();
                if (!player.lastShot || now - player.lastShot > player.currentWeapon.fireRate) {
                    shoot();
                    player.lastShot = now;
                    
                    if (player.currentWeapon.ammo !== Infinity) {
                        player.currentWeapon.ammo--;
                        updateAmmoDisplay();
                    }
                }
            }
            
            // Zmiana broni
            if (keys['1'] && player.weapons[0]) selectWeapon(0);
            if (keys['2'] && player.weapons[1]) selectWeapon(1);
            if (keys['3'] && player.weapons[2]) selectWeapon(2);
            if (keys['4'] && player.weapons[3]) selectWeapon(3);
            if (keys['5'] && player.weapons[4]) selectWeapon(4);
        }
        
        function shoot() {
            const angle = Math.atan2(mouse.y - player.y, mouse.x - player.x);
            
            bullets.push({
                x: player.x,
                y: player.y,
                radius: 3,
                speed: 10,
                damage: player.currentWeapon.damage,
                color: player.currentWeapon.color,
                velocity: {
                    x: Math.cos(angle) * 10,
                    y: Math.sin(angle) * 10
                }
            });
        }
        
        function selectWeapon(index) {
            if (player.weapons[index]) {
                player.currentWeaponIndex = index;
                player.currentWeapon = player.weapons[index];
                updateAmmoDisplay();
            }
        }
        
        function updateBullets() {
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                
                // Aktualizacja pozycji
                bullet.x += bullet.velocity.x;
                bullet.y += bullet.velocity.y;
                
                // Usuwanie pocisków poza ekranem
                if (bullet.x < -50 || bullet.x > canvas.width + 50 ||
                    bullet.y < -50 || bullet.y > canvas.height + 50) {
                    bullets.splice(i, 1);
                }
            }
        }
        
        function updateZombies() {
            // Spawn nowych zombie
            if (zombiesToSpawn > 0 && Math.random() < 0.05) {
                spawnZombie();
                zombiesToSpawn--;
            }
            
            // Aktualizacja pozycji zombie
            for (let i = zombies.length - 1; i >= 0; i--) {
                const zombie = zombies[i];
                
                // Poruszanie się w kierunku gracza
                const dx = player.x - zombie.x;
                const dy = player.y - zombie.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                zombie.x += (dx / distance) * zombie.speed;
                zombie.y += (dy / distance) * zombie.speed;
                
                // Sprawdzanie kolizji z graczem
                if (distance < player.radius + zombie.radius) {
                    player.health -= zombie.damage;
                    updateHealthDisplay();
                    
                    zombies.splice(i, 1);
                    zombiesKilledInWave++;
                    
                    if (player.health <= 0) {
                        gameOver();
                    }
                }
            }
        }
        
        function spawnZombie() {
            const ruin = ruins[Math.floor(Math.random() * ruins.length)];
            const zombieType = Math.floor(Math.random() * 3); // 3 typy zombie
            
            zombies.push({
                x: ruin.x,
                y: ruin.y,
                radius: 15,
                color: zombieColors[zombieType],
                speed: 1 + Math.random() * 1.5,
                health: 20 + zombieType * 15,
                damage: 5 + zombieType * 3
            });
        }
        
        function checkCollisions() {
            // Sprawdzanie kolizji pocisków z zombie
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                
                for (let j = zombies.length - 1; j >= 0; j--) {
                    const zombie = zombies[j];
                    
                    const dx = bullet.x - zombie.x;
                    const dy = bullet.y - zombie.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < bullet.radius + zombie.radius) {
                        // Trafienie
                        zombie.health -= bullet.damage;
                        
                        // Usuwanie pocisku
                        bullets.splice(i, 1);
                        
                        // Sprawdzanie czy zombie zginęło
                        if (zombie.health <= 0) {
                            zombies.splice(j, 1);
                            zombiesKilledInWave++;
                            score += 10;
                            money += 5;
                            updateScoreDisplay();
                        }
                        
                        break;
                    }
                }
            }
        }
        
        function checkWaveCompletion() {
            if (zombies.length === 0 && zombiesToSpawn === 0) {
                endWave();
            }
        }
        
        function startWave(waveNumber) {
            currentWave = waveNumber;
            zombiesToSpawn = 5 + waveNumber * 3;
            zombiesKilledInWave = 0;
            
            waveDisplay.textContent = `Fala: ${currentWave}`;
            gameState = 'playing';
        }
        
        function endWave() {
            if (currentWave >= 10) {
                // Gra ukończona
                gameOver();
                return;
            }
            
            gameState = 'shop';
            shopTimer = 120;
            updateTimerDisplay();
            
            // Pokazanie sklepu
            shopScreen.style.display = 'block';
            moneyDisplay.textContent = `Pieniądze: ${money}`;
            
            // Wyczyszczenie i dodanie przedmiotów do sklepu
            shopItems.innerHTML = '';
            
            weapons.forEach((weapon, index) => {
                // Sprawdzanie czy gracz już ma tę broń
                const hasWeapon = player.weapons.some(w => w.name === weapon.name);
                
                if (!hasWeapon || weapon.ammo !== Infinity) {
                    const item = document.createElement('div');
                    item.className = 'shop-item';
                    
                    let html = `<h3>${weapon.name}</h3>`;
                    html += `<p>Obrażenia: ${weapon.damage}</p>`;
                    
                    if (weapon.ammo === Infinity) {
                        html += `<p>Amunicja: Nieograniczona</p>`;
                    } else {
                        html += `<p>Amunicja: ${weapon.maxAmmo}</p>`;
                    }
                    
                    html += `<p>Koszt: ${weapon.cost}</p>`;
                    
                    if (hasWeapon && weapon.ammo !== Infinity) {
                        html += `<p>Kup amunicję</p>`;
                    }
                    
                    item.innerHTML = html;
                    
                    if (money >= weapon.cost) {
                        item.addEventListener('click', () => purchaseWeapon(index));
                    } else {
                        item.style.opacity = '0.5';
                    }
                    
                    shopItems.appendChild(item);
                }
            });
            
            // Rozpoczęcie odliczania czasu sklepu
            clearInterval(shopInterval);
            shopInterval = setInterval(() => {
                shopTimer--;
                updateTimerDisplay();
                
                if (shopTimer <= 0) {
                    startNextWave();
                }
            }, 1000);
        }
        
        function purchaseWeapon(index) {
            const weapon = weapons[index];
            
            if (money >= weapon.cost) {
                // Sprawdzanie czy gracz już ma tę broń
                const existingWeaponIndex = player.weapons.findIndex(w => w.name === weapon.name);
                
                if (existingWeaponIndex === -1) {
                    // Kupowanie nowej broni
                    player.weapons.push({...weapon});
                    money -= weapon.cost;
                    selectWeapon(player.weapons.length - 1);
                } else if (weapon.ammo !== Infinity) {
                    // Uzupełnianie amunicji
                    player.weapons[existingWeaponIndex].ammo = weapon.maxAmmo;
                    money -= weapon.cost;
                    
                    if (player.currentWeaponIndex === existingWeaponIndex) {
                        updateAmmoDisplay();
                    }
                }
                
                moneyDisplay.textContent = `Pieniądze: ${money}`;
                
                // Odświeżenie sklepu
                shopItems.innerHTML = '';
                weapons.forEach((w, i) => {
                    const hasWeapon = player.weapons.some(wp => wp.name === w.name);
                    
                    if (!hasWeapon || w.ammo !== Infinity) {
                        const item = document.createElement('div');
                        item.className = 'shop-item';
                        
                        let html = `<h3>${w.name}</h3>`;
                        html += `<p>Obrażenia: ${w.damage}</p>`;
                        
                        if (w.ammo === Infinity) {
                            html += `<p>Amunicja: Nieograniczona</p>`;
                        } else {
                            html += `<p>Amunicja: ${w.maxAmmo}</p>`;
                        }
                        
                        html += `<p>Koszt: ${w.cost}</p>`;
                        
                        if (hasWeapon && w.ammo !== Infinity) {
                            html += `<p>Kup amunicję</p>`;
                        }
                        
                        item.innerHTML = html;
                        
                        if (money >= w.cost) {
                            item.addEventListener('click', () => purchaseWeapon(i));
                        } else {
                            item.style.opacity = '0.5';
                        }
                        
                        shopItems.appendChild(item);
                    }
                });
            }
        }
        
        function startNextWave() {
            clearInterval(shopInterval);
            shopScreen.style.display = 'none';
            startWave(currentWave + 1);
        }
        
        function gameOver() {
            gameState = 'gameOver';
            finalScoreDisplay.textContent = `Twój wynik: ${score}`;
            gameOverScreen.style.display = 'block';
        }
        
        function restartGame() {
            // Resetowanie stanu gry
            score = 0;
            money = 0;
            currentWave = 0;
            player.health = player.maxHealth;
            player.weapons = [{...weapons[0]}];
            player.currentWeaponIndex = 0;
            player.currentWeapon = player.weapons[0];
            
            bullets = [];
            zombies = [];
            
            updateHealthDisplay();
            updateScoreDisplay();
            updateAmmoDisplay();
            
            gameOverScreen.style.display = 'none';
            
            startWave(1);
        }
        
        function updateHealthDisplay() {
            const healthPercent = (player.health / player.maxHealth) * 100;
            healthBar.style.width = `${healthPercent}%`;
        }
        
        function updateScoreDisplay() {
            scoreDisplay.textContent = `Punkty: ${score}`;
        }
        
        function updateAmmoDisplay() {
            if (player.currentWeapon.ammo === Infinity) {
                ammoDisplay.textContent = `Amunicja: ∞`;
            } else {
                ammoDisplay.textContent = `Amunicja: ${player.currentWeapon.ammo}/${player.currentWeapon.maxAmmo}`;
            }
        }
        
        function updateTimerDisplay() {
            timerDisplay.textContent = `Czas: ${shopTimer}s`;
        }
        
        function render() {
            // Czyszczenie canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Rysowanie areny
            ctx.beginPath();
            ctx.arc(canvas.width / 2, canvas.height / 2, 250, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(50, 50, 50, 0.3)';
            ctx.fill();
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // Rysowanie ruin
            ctx.fillStyle = '#555';
            ruins.forEach(ruin => {
                ctx.beginPath();
                ctx.arc(ruin.x, ruin.y, 30, 0, Math.PI * 2);
                ctx.fill();
            });
            
            // Rysowanie pocisków
            bullets.forEach(bullet => {
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, bullet.radius, 0, Math.PI * 2);
                ctx.fillStyle = bullet.color;
                ctx.fill();
            });
            
            // Rysowanie zombie
            zombies.forEach(zombie => {
                ctx.beginPath();
                ctx.arc(zombie.x, zombie.y, zombie.radius, 0, Math.PI * 2);
                ctx.fillStyle = zombie.color;
                ctx.fill();
                
                // Oczy zombie
                const dx = player.x - zombie.x;
                const dy = player.y - zombie.y;
                const angle = Math.atan2(dy, dx);
                
                const eyeRadius = zombie.radius / 4;
                const eyeOffset = zombie.radius / 2;
                
                ctx.beginPath();
                ctx.arc(
                    zombie.x + Math.cos(angle) * eyeOffset,
                    zombie.y + Math.sin(angle) * eyeOffset,
                    eyeRadius, 0, Math.PI * 2
                );
                ctx.fillStyle = 'white';
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(
                    zombie.x + Math.cos(angle) * (eyeOffset + eyeRadius / 2),
                    zombie.y + Math.sin(angle) * (eyeOffset + eyeRadius / 2),
                    eyeRadius / 2, 0, Math.PI * 2
                );
                ctx.fillStyle = 'black';
                ctx.fill();
            });
            
            // Rysowanie gracza
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
            ctx.fillStyle = player.color;
            ctx.fill();
            
            // Rysowanie broni
            const angle = Math.atan2(mouse.y - player.y, mouse.x - player.x);
            const weaponLength = player.currentWeapon.size * 2;
            
            ctx.save();
            ctx.translate(player.x, player.y);
            ctx.rotate(angle);
            
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(weaponLength, 0);
            ctx.lineWidth = player.currentWeapon.size;
            ctx.strokeStyle = player.currentWeapon.color;
            ctx.stroke();
            
            ctx.restore();
            
            // Rysowanie celownika
            ctx.beginPath();
            ctx.arc(mouse.x, mouse.y, 5, 0, Math.PI * 2);
            ctx.strokeStyle = 'white';
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(mouse.x - 10, mouse.y);
            ctx.lineTo(mouse.x + 10, mouse.y);
            ctx.moveTo(mouse.x, mouse.y - 10);
            ctx.lineTo(mouse.x, mouse.y + 10);
            ctx.stroke();
        }
        
        // Inicjalizacja gry
        updateHealthDisplay();
        updateScoreDisplay();
        updateAmmoDisplay();
        startWave(1);
        gameLoop();
    </script>
</body>
</html>
